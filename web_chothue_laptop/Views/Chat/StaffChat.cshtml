@{
    ViewData["Title"] = "Hỗ trợ khách hàng - Staff";
    var staffId = ViewBag.StaffId;
    var staffName = ViewBag.StaffName;
    var activeCustomers = ViewBag.ActiveCustomers as List<web_chothue_laptop.Services.ActiveCustomer> ?? new List<web_chothue_laptop.Services.ActiveCustomer>();
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-headset"></i> Hỗ trợ khách hàng - Staff
                    </h4>
                </div>
                <div class="card-body p-0">
                    <div class="row g-0" style="height: 600px;">
                        <!-- Danh sách khách hàng -->
                        <div class="col-md-4 border-end" style="overflow-y: auto; background-color: #f8f9fa;">
                            <div class="p-3 border-bottom bg-white">
                                <h5 class="mb-0">Khách hàng đang chat</h5>
                            </div>
                            <div id="customersList">
                                @foreach (var customer in activeCustomers)
                                {
                                    <div class="customer-item p-3 border-bottom cursor-pointer" 
                                         data-customer-id="@customer.CustomerId" 
                                         data-customer-name="@customer.CustomerName"
                                         onclick="selectCustomer(@customer.CustomerId, '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(customer.CustomerName))')"
                                         style="cursor: pointer; transition: background-color 0.2s;">
                                        <div class="fw-bold">@customer.CustomerName</div>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <!-- Khu vực chat -->
                        <div class="col-md-8 d-flex flex-column">
                            <div id="chatArea" class="flex-grow-1 p-3" style="overflow-y: auto; background-color: #ffffff; min-height: 500px;">
                                <div id="noCustomerSelected" class="text-center text-muted mt-5">
                                    <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Chọn một khách hàng để bắt đầu chat</p>
                                </div>
                                <div id="messagesList" style="display: none;"></div>
                            </div>
                            <div class="border-top p-3 bg-white">
                                <div class="input-group">
                                    <input type="text" id="messageInput" class="form-control" 
                                           placeholder="Nhập tin nhắn..." disabled />
                                    <button class="btn btn-success" id="sendButton" disabled>
                                        <i class="bi bi-send"></i> Gửi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub", {
                skipNegotiation: false,
                transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling
            })
            .withAutomaticReconnect({
                nextRetryDelayInMilliseconds: retryContext => {
                    if (retryContext.elapsedMilliseconds < 60000) {
                        // Retry quickly for the first minute
                        return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 10000);
                    }
                    // After a minute, retry every 10 seconds
                    return 10000;
                }
            })
            .build();

        const staffId = @staffId;
        const staffName = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(staffName));
        let selectedCustomerId = null;
        let selectedCustomerName = null;
        let pendingMessages = new Map(); // Store messages received when customer not selected

        // Connection state handlers
        connection.onreconnecting(function (error) {
            console.log("SignalR reconnecting...", error);
        });

        connection.onreconnected(function (connectionId) {
            console.log("SignalR reconnected:", connectionId);
            // Rejoin staff group after reconnection
            connection.invoke("JoinStaffGroup").catch(function (err) {
                console.error("Error rejoining staff group:", err.toString());
            });
        });

        connection.onclose(function (error) {
            console.log("SignalR connection closed", error);
            // Try to reconnect
            setTimeout(function() {
                connection.start().catch(function (err) {
                    console.error("Error reconnecting:", err.toString());
                });
            }, 5000);
        });

        connection.start().then(function () {
            console.log("SignalR Connected");
            connection.invoke("JoinStaffGroup").then(function () {
                console.log("Joined staff group");
            }).catch(function (err) {
                console.error("Error joining staff group:", err.toString());
            });
        }).catch(function (err) {
            console.error("SignalR connection error:", err.toString());
            // Don't show alert immediately, let auto-reconnect handle it
        });

        connection.on("ReceiveMessage", function (data) {
            console.log("Received message:", data);
            
            // Nếu đang chọn customer này, hiển thị tin nhắn ngay
            if (data.customerId && data.customerId === selectedCustomerId) {
                // Kiểm tra xem tin nhắn đã tồn tại chưa (tránh duplicate)
                const messagesList = document.getElementById('messagesList');
                const existingMessages = Array.from(messagesList.children);
                const messageExists = existingMessages.some(msgDiv => {
                    const messageText = msgDiv.querySelector('div:last-of-type')?.textContent;
                    return messageText && messageText.trim() === data.message.trim();
                });
                
                if (!messageExists) {
                    displayMessage(data, data.senderType);
                }
            }
            // Nếu chưa chọn customer này, lưu tin nhắn để hiển thị sau
            else if (data.customerId) {
                // Lưu tin nhắn vào pendingMessages
                if (!pendingMessages.has(data.customerId)) {
                    pendingMessages.set(data.customerId, []);
                }
                pendingMessages.get(data.customerId).push(data);
                
                // Nếu chưa chọn customer nào, tự động chọn customer này
                if (!selectedCustomerId) {
                    selectCustomer(data.customerId, data.customerName);
                }
                
                // Update customer list
                updateCustomerList(data.customerId, data.customerName);
            }
        });

        connection.on("CustomerJoined", function (customerId) {
            console.log("Customer joined:", customerId);
            // Không reload trang, chỉ update customer list
            // Có thể thêm customer vào list nếu chưa có
        });

        connection.on("MessageSent", function (data) {
            // Message sent confirmation
        });

        function selectCustomer(customerId, customerName) {
            console.log("Selecting customer:", customerId, customerName);
            
            // Nếu đang chọn customer này rồi, không làm gì
            if (selectedCustomerId === customerId) {
                return;
            }
            
            selectedCustomerId = customerId;
            selectedCustomerName = customerName;
            
            // Update UI
            document.querySelectorAll('.customer-item').forEach(item => {
                item.style.backgroundColor = '';
            });
            const selectedItem = document.querySelector(`[data-customer-id="${customerId}"]`);
            if (selectedItem) {
                selectedItem.style.backgroundColor = '#e3f2fd';
            }
            
            // Show chat area
            document.getElementById('noCustomerSelected').style.display = 'none';
            const messagesList = document.getElementById('messagesList');
            messagesList.style.display = 'block';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            // Clear current messages and always load fresh conversation history
            messagesList.innerHTML = '';
            loadConversationHistory(customerId).then(() => {
                // After loading history, display any pending messages
                if (pendingMessages.has(customerId)) {
                    const pending = pendingMessages.get(customerId);
                    pending.forEach(msg => {
                        displayMessage(msg, msg.senderType);
                    });
                    pendingMessages.delete(customerId);
                }
            });
        }

        async function loadConversationHistory(customerId) {
            try {
                console.log("Loading conversation history for customer:", customerId);
                const response = await fetch(`/Chat/GetConversationHistory?customerId=${customerId}`);
                if (!response.ok) {
                    console.error("Failed to load conversation history:", response.status);
                    return;
                }
                const messages = await response.json();
                console.log("Loaded messages:", messages);
                
                const messagesList = document.getElementById('messagesList');
                
                // Always load messages if we're selecting this customer
                if (selectedCustomerId === customerId && messages && messages.length > 0) {
                    messages.forEach(msg => {
                        displayMessage({
                            message: msg.message,
                            senderType: msg.senderType,
                            customerName: msg.senderType === 'customer' ? msg.senderName : null,
                            staffName: msg.senderType === 'staff' ? msg.senderName : null,
                            timestamp: msg.timestamp
                        }, msg.senderType);
                    });
                }
                
                const chatArea = document.getElementById('chatArea');
                if (chatArea) {
                    chatArea.scrollTop = chatArea.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        function displayMessage(data, senderType) {
            console.log("Displaying message:", data, "senderType:", senderType);
            const messagesList = document.getElementById('messagesList');
            if (!messagesList) {
                console.error("messagesList element not found");
                return;
            }
            
            // Check for duplicate messages
            const existingMessages = Array.from(messagesList.children);
            const messageExists = existingMessages.some(msgDiv => {
                const msgContent = msgDiv.querySelector('div > div:nth-child(2)');
                const msgTimestamp = msgDiv.querySelector('div > div:nth-child(3)');
                if (!msgContent) return false;
                
                const existingText = msgContent.textContent.trim();
                const newText = (data.message || '').trim();
                
                // Check if message text and timestamp match (within 1 second tolerance)
                if (existingText === newText && msgTimestamp) {
                    const existingTime = new Date(msgTimestamp.textContent);
                    const newTime = data.timestamp ? new Date(data.timestamp) : new Date();
                    const timeDiff = Math.abs(existingTime.getTime() - newTime.getTime());
                    return timeDiff < 1000; // 1 second tolerance
                }
                return false;
            });
            
            if (messageExists) {
                console.log("Duplicate message detected, skipping");
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-3 ' + (senderType === 'customer' ? 'text-start' : 'text-end');
            
            const messageContent = document.createElement('div');
            messageContent.className = 'd-inline-block p-3 rounded ' + 
                (senderType === 'customer' ? 'bg-light border' : 'bg-success text-white');
            messageContent.style.maxWidth = '70%';
            
            const senderName = document.createElement('div');
            senderName.className = 'fw-bold small';
            senderName.textContent = senderType === 'customer' ? 
                (data.customerName || 'Khách hàng') : 
                (data.staffName || staffName);
            
            const messageText = document.createElement('div');
            messageText.textContent = data.message || '';
            
            const timestamp = document.createElement('div');
            timestamp.className = 'small mt-1 opacity-75';
            const date = data.timestamp ? new Date(data.timestamp) : new Date();
            timestamp.textContent = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + 
                ' ' + date.toLocaleDateString('vi-VN');
            
            messageContent.appendChild(senderName);
            messageContent.appendChild(messageText);
            messageContent.appendChild(timestamp);
            messageDiv.appendChild(messageContent);
            messagesList.appendChild(messageDiv);
            
            const chatArea = document.getElementById('chatArea');
            if (chatArea) {
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function updateCustomerList(customerId, customerName) {
            // Check if customer already in list
            const existingItem = document.querySelector(`[data-customer-id="${customerId}"]`);
            if (!existingItem) {
                const customersList = document.getElementById('customersList');
                const customerDiv = document.createElement('div');
                customerDiv.className = 'customer-item p-3 border-bottom cursor-pointer';
                customerDiv.setAttribute('data-customer-id', customerId);
                customerDiv.setAttribute('data-customer-name', customerName);
                customerDiv.style.cursor = 'pointer';
                customerDiv.onclick = () => selectCustomer(customerId, customerName);
                customerDiv.innerHTML = `
                    <div class="fw-bold">${customerName}</div>
                `;
                customersList.insertBefore(customerDiv, customersList.firstChild);
            }
        }

        document.getElementById('sendButton').addEventListener('click', function (event) {
            if (!selectedCustomerId) return;
            
            const message = document.getElementById('messageInput').value;
            if (message.trim() === '') return;
            
            // Hiển thị tin nhắn ngay lập tức (optimistic update)
            displayMessage({
                message: message,
                senderType: 'staff',
                staffName: staffName,
                timestamp: new Date().toISOString()
            }, 'staff');
            
            // Xóa input
            document.getElementById('messageInput').value = '';
            
            // Gửi lên server
            connection.invoke('SendMessageToCustomer', selectedCustomerId, staffName, message, staffId)
                .catch(function (err) {
                    console.error('Error sending message:', err.toString());
                    alert('Không thể gửi tin nhắn. Vui lòng thử lại.');
                });
        });

        document.getElementById('messageInput').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                document.getElementById('sendButton').click();
            }
        });
    </script>
    
    <style>
        .customer-item:hover {
            background-color: #e3f2fd !important;
        }
    </style>
}

