@model IEnumerable<web_chothue_laptop.Models.Laptop>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Students";
}

<style>
    .nav-pills .nav-link {
        border-radius: 20px;
        padding: 10px 20px;
        margin-right: 5px;
        color: #495057;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        transition: all 0.3s;
    }

    .nav-pills .nav-link:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-pills .nav-link.active {
        font-weight: bold;
    }

    .nav-pills .nav-link.active:has(.badge.bg-secondary) {
        background-color: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    .nav-pills .nav-link.active:has(.badge.bg-warning) {
        background-color: #ffc107;
        color: #000;
        border-color: #ffc107;
    }

    .nav-pills .nav-link.active:has(.badge.bg-success) {
        background-color: #198754;
        color: white;
        border-color: #198754;
    }

    .nav-pills .nav-link.active:has(.badge.bg-danger) {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .nav-pills .badge {
        margin-left: 5px;
    }
</style>

@functions {
    private static string TranslateStatus(string? name) => name?.ToLower() switch
    {
        "pending" => "Đang chờ xử lý",
        "đang chờ xử lý" => "Đang chờ xử lý",
        "approved" => "Đã phê duyệt",
        "rejected" => "Bị từ chối",
        "active" => "Hoạt động",
        "available" => "Có sẵn",
        "broken" => "Hỏng",
        "close" => "Đóng",
        "fixed" => "Đã sửa",
        "fixing" => "Đang sửa",
        "inactive" => "Không hoạt động",
        "rented" => "Đã thuê",
        _ => name ?? string.Empty
    };
}

<h2>Thuê laptop cho sinh viên</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Tabs/Pills để lọc theo trạng thái -->
<ul class="nav nav-pills mb-3" id="statusTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link @(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "active" : "")" 
           href="?status=&search=@(ViewBag.Search ?? "")">
            Tất cả <span class="badge bg-secondary">@ViewBag.TotalAll</span>
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link @(ViewBag.CurrentStatus == "pending" ? "active" : "")" 
           href="?status=pending&search=@(ViewBag.Search ?? "")">
            Đang chờ xử lý <span class="badge bg-warning text-dark">@ViewBag.TotalPending</span>
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link @(ViewBag.CurrentStatus == "approved" ? "active" : "")" 
           href="?status=approved&search=@(ViewBag.Search ?? "")">
            Đã phê duyệt <span class="badge bg-success">@ViewBag.TotalApproved</span>
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link @(ViewBag.CurrentStatus == "rejected" ? "active" : "")" 
           href="?status=rejected&search=@(ViewBag.Search ?? "")">
            Bị từ chối <span class="badge bg-danger">@ViewBag.TotalRejected</span>
        </a>
    </li>
</ul>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <a class="btn btn-primary" href="/student/create">Tạo laptop cho thuê</a>
        <a class="btn btn-secondary" href="/student/report">Báo cáo</a>
    </div>
    <form method="get" class="d-flex" style="width:360px;">
        <input type="search" name="search" value="@(ViewBag.Search ?? "")" class="form-control" placeholder="Tìm tên hoặc hãng" />
        <button class="btn btn-outline-secondary ms-2" type="submit">Tìm</button>
    </form>
</div>


<div class="table-responsive">
    <table class="table table-bordered table-sm" style="border-collapse:collapse;">
    <thead>
        <tr>
            <th class="px-3 py-2">Tên</th>
            <th class="px-3 py-2">Hãng</th>
            <th class="px-3 py-2">Giá</th>
            <th class="px-3 py-2">Trạng thái</th>
            <th class="px-3 py-2">Thao tác</th>
        </tr>
    </thead>
    <tbody>
@foreach(var l in Model)
{
    <tr>
        <td class="align-middle px-3 py-2">@l.Name</td>
        <td class="align-middle px-3 py-2">@l.Brand?.BrandName</td>
        <td class="align-middle px-3 py-2">@(l.Price?.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN")) ?? "-")</td>
        <td class="align-middle px-3 py-2">@TranslateStatus(l.Status?.StatusName)</td>
        <td class="align-middle px-3 py-2">
            <a class="btn btn-sm btn-success me-1" href="/student/detail/@l.Id">Xem chi tiết</a>
           
            <form asp-action="Delete" asp-route-id="@l.Id" asp-controller="Student" method="post" style="display:inline" onsubmit="return confirm('Bạn có chắc muốn xóa laptop này không?');">
                @Html.AntiForgeryToken()
                <button class="btn btn-sm btn-danger" type="submit">Xóa</button>
            </form>
        </td>
    </tr>
}
    </tbody>
</table>
</div>

@if (ViewBag.TotalPages > 1)
{
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
            @* Nút Previous *@
            <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="?page=@(ViewBag.CurrentPage - 1)@(string.IsNullOrEmpty(ViewBag.Search) ? "" : "&search=" + ViewBag.Search)@(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "" : "&status=" + ViewBag.CurrentStatus)">Trước</a>
            </li>

            @* Hiển thị các số trang *@
            @{
                int currentPage = ViewBag.CurrentPage;
                int totalPages = ViewBag.TotalPages;
                int startPage = Math.Max(1, currentPage - 2);
                int endPage = Math.Min(totalPages, currentPage + 2);
            }

            @if (startPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" href="?page=1@(string.IsNullOrEmpty(ViewBag.Search) ? "" : "&search=" + ViewBag.Search)@(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "" : "&status=" + ViewBag.CurrentStatus)">1</a>
                </li>
                @if (startPage > 2)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
            }

            @for (int i = startPage; i <= endPage; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <a class="page-link" href="?page=@i@(string.IsNullOrEmpty(ViewBag.Search) ? "" : "&search=" + ViewBag.Search)@(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "" : "&status=" + ViewBag.CurrentStatus)">@i</a>
                </li>
            }

            @if (endPage < totalPages)
            {
                @if (endPage < totalPages - 1)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
                <li class="page-item">
                    <a class="page-link" href="?page=@totalPages@(string.IsNullOrEmpty(ViewBag.Search) ? "" : "&search=" + ViewBag.Search)@(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "" : "&status=" + ViewBag.CurrentStatus)">@totalPages</a>
                </li>
            }

            @* Nút Next *@
            <li class="page-item @(ViewBag.CurrentPage >= ViewBag.TotalPages ? "disabled" : "")">
                <a class="page-link" href="?page=@(ViewBag.CurrentPage + 1)@(string.IsNullOrEmpty(ViewBag.Search) ? "" : "&search=" + ViewBag.Search)@(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "" : "&status=" + ViewBag.CurrentStatus)">Sau</a>
            </li>
        </ul>
        <p class="text-center text-muted">
            Hiển thị trang @ViewBag.CurrentPage / @ViewBag.TotalPages (Tổng: @ViewBag.TotalItems laptop)
        </p>
    </nav>
}
