@model IEnumerable<web_chothue_laptop.Models.TechnicalTicket>
@{
    ViewData["Title"] = "Báo Cáo Thu Nhập & Lịch Sử";
    var completedBookings = ViewBag.CompletedBookings as IEnumerable<web_chothue_laptop.Models.BookingReceipt>;
    var rentedBookings = ViewBag.RentedBookings as IEnumerable<web_chothue_laptop.Models.Booking>;
    
    // Pagination settings
    int pageSize = 5;
    int completedPage = ViewBag.CompletedPage ?? 1;
    int ticketsPage = ViewBag.TicketsPage ?? 1;
    
    var completedPaged = completedBookings?.Skip((completedPage - 1) * pageSize).Take(pageSize).ToList() ?? new List<web_chothue_laptop.Models.BookingReceipt>();
    var ticketsPaged = Model?.Skip((ticketsPage - 1) * pageSize).Take(pageSize).ToList() ?? new List<web_chothue_laptop.Models.TechnicalTicket>();
    
    int totalCompletedPages = (int)Math.Ceiling((completedBookings?.Count() ?? 0) / (double)pageSize);
    int totalTicketsPages = (int)Math.Ceiling((Model?.Count() ?? 0) / (double)pageSize);
}

@functions {
    private static string TranslateStatus(string? name) => name?.ToLower() switch
    {
        "pending" => "Đang chờ xử lý",
        "approved" => "Đã duyệt",
        "rejected" => "Bị từ chối",
        "fixed" => "Đã sửa xong",
        "processing" => "Đang sửa chữa",
        "broken" => "Hư hỏng",
        "rented" => "Đang cho thuê",
        "completed" => "Đã hoàn thành",
        _ => name ?? "Không xác định"
    };

    private static string GetStatusTextClass(string? name) => name?.ToLower() switch
    {
        "pending" => "text-black fw-bold",
        "approved" => "text-black fw-bold",
        "rejected" => "text-black fw-bold",
        "fixed" => "text-black fw-bold",
        "processing" => "text-black fw-bold",
        "broken" => "text-black fw-bold",
        "rented" => "text-black fw-bold",
        "completed" => "text-black fw-bold",
        _ => "text-secondary fw-bold"
    };
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">
            <i class="fas fa-chart-line me-2"></i>Báo Cáo Thu Nhập & Lịch Sử
        </h2>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Tổng Thu Nhập</h6>
                            <h2 class="mb-0">@(ViewBag.Income ?? "0 VNĐ")</h2>
                            <small class="opacity-75">Từ @(completedBookings?.Count() ?? 0) đơn hoàn thành</small>
                        </div>
                        <i class="fas fa-dollar-sign fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-warning text-dark shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Ticket Kỹ Thuật</h6>
                            <h2 class="mb-0">@Model.Count()</h2>
                            <small>Phiếu sửa chữa</small>
                        </div>
                        <i class="fas fa-wrench fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" id="reportTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                <i class="fas fa-check-circle me-1"></i>Đã Hoàn Thành 
                <span class="badge bg-success ms-1">@(completedBookings?.Count() ?? 0)</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#tickets" type="button">
                <i class="fas fa-tools me-1"></i>Phiếu Kỹ Thuật 
                <span class="badge bg-warning ms-1">@(Model?.Count() ?? 0)</span>
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="reportTabContent">
        <!-- Tab: Đã hoàn thành -->
        <div class="tab-pane fade show active" id="completed" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-success">
                        <i class="fas fa-check-circle me-2"></i>Lịch Sử Cho Thuê Đã Hoàn Thành
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (completedBookings != null && completedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center">Mã Receipt</th>
                                        <th>Laptop</th>
                                        <th>Khách Hàng</th>
                                        <th class="text-center">Ngày Thuê</th>
                                        <th class="text-center">Ngày Trả</th>
                                        <th class="text-end">Thu Nhập</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var receipt in completedPaged)
                                    {
                                        <tr>
                                            <td class="text-center"><span class="badge bg-success">#@receipt.Id</span></td>
                                            <td>@receipt.Booking?.Laptop?.Name</td>
                                            <td>@(receipt.Booking?.Customer?.LastName) @(receipt.Booking?.Customer?.FirstName)</td>
                                            <td class="text-center">@receipt.StartTime.ToString("dd/MM/yyyy")</td>
                                            <td class="text-center">@receipt.EndTime.ToString("dd/MM/yyyy")</td>
                                            <td class="text-end fw-bold text-success">@receipt.TotalPrice.ToString("#,##0") đ</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        @if (totalCompletedPages > 1)
                        {
                            <div class="card-footer">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 justify-content-center">
                                        <li class="page-item @(completedPage == 1 ? "disabled" : "")">
                                            <a class="page-link" href="?tab=completed&page=@(completedPage - 1)">Trước</a>
                                        </li>
                                        
                                        @for (int i = 1; i <= totalCompletedPages; i++)
                                        {
                                            <li class="page-item @(i == completedPage ? "active" : "")">
                                                <a class="page-link" href="?tab=completed&page=@i">@i</a>
                                            </li>
                                        }
                                        
                                        <li class="page-item @(completedPage == totalCompletedPages ? "disabled" : "")">
                                            <a class="page-link" href="?tab=completed&page=@(completedPage + 1)">Sau</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-history fa-3x mb-3 d-block"></i>
                            <p class="mb-0">Chưa có đơn thuê nào hoàn thành</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Phiếu kỹ thuật -->
        <div class="tab-pane fade" id="tickets" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-warning">
                        <i class="fas fa-tools me-2"></i>Phiếu Kỹ Thuật
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (Model != null && Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center">Mã Ticket</th>
                                        <th class="text-center">Ngày Tạo</th>
                                        <th>Laptop</th>
                                        <th>Mô Tả</th>
                                        <th class="text-center">Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ticket in ticketsPaged)
                                    {
                                        <tr>
                                            <td class="text-center"><span class="badge bg-primary">#@ticket.Id</span></td>
                                            <td class="text-center">@ticket.CreatedDate?.ToString("dd/MM/yyyy")</td>
                                            <td>@ticket.Laptop?.Name</td>
                                            <td>@ticket.Description</td>
                                            <td class="text-center">
                                                <span class="@GetStatusTextClass(ticket.Status?.StatusName)">
                                                    @TranslateStatus(ticket.Status?.StatusName)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        @if (totalTicketsPages > 1)
                        {
                            <div class="card-footer">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 justify-content-center">
                                        <li class="page-item @(ticketsPage == 1 ? "disabled" : "")">
                                            <a class="page-link" href="?tab=tickets&page=@(ticketsPage - 1)">Trước</a>
                                        </li>
                                        
                                        @for (int i = 1; i <= totalTicketsPages; i++)
                                        {
                                            <li class="page-item @(i == ticketsPage ? "active" : "")">
                                                <a class="page-link" href="?tab=tickets&page=@i">@i</a>
                                            </li>
                                        }
                                        
                                        <li class="page-item @(ticketsPage == totalTicketsPages ? "disabled" : "")">
                                            <a class="page-link" href="?tab=tickets&page=@(ticketsPage + 1)">Sau</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <p class="mb-0">Chưa có phiếu kỹ thuật nào</p>
                            <small>Các phiếu báo lỗi máy sẽ hiển thị tại đây</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Check URL parameter for active tab
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');
            
            if (activeTab === 'tickets') {
                $('#tickets-tab').tab('show');
            } else {
                $('#completed-tab').tab('show');
            }
            
            // Update URL when tab changes
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const targetTab = $(e.target).attr('data-bs-target');
                const tabName = targetTab === '#tickets' ? 'tickets' : 'completed';
                
                const newUrl = window.location.pathname + '?tab=' + tabName;
                window.history.pushState({path: newUrl}, '', newUrl);
            });
        });
    </script>
}


