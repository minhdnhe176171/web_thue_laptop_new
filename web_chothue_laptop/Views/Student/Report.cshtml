@model IEnumerable<web_chothue_laptop.Models.TechnicalTicket>
@{
    ViewData["Title"] = "Báo Cáo Thu Nhập & Lịch Sử Cho Thuê";
    var completedBookings = ViewBag.CompletedBookings as IEnumerable<web_chothue_laptop.Models.BookingReceipt>;
    var rentedBookings = ViewBag.RentedBookings as IEnumerable<web_chothue_laptop.Models.Booking>;
}

@functions {
    private static string TranslateStatus(string? name) => name?.ToLower() switch
    {
        "pending" => "Đang chờ xử lý",
        "approved" => "Đã duyệt",
        "rejected" => "Bị từ chối",
        "fixed" => "Đã sửa xong",
        "processing" => "Đang sửa chữa",
        "broken" => "Hư hỏng",
        "rented" => "Đang cho thuê",
        "completed" => "Đã hoàn thành",
        _ => name ?? "Không xác định"
    };

    private static string GetStatusBadgeClass(string? name) => name?.ToLower() switch
    {
        "pending" => "bg-warning text-dark",
        "approved" => "bg-success",
        "rejected" => "bg-danger",
        "fixed" => "bg-success",
        "processing" => "bg-info",
        "broken" => "bg-danger",
        "rented" => "bg-primary",
        "completed" => "bg-success",
        _ => "bg-secondary"
    };
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">
            <i class="fas fa-chart-line me-2"></i>Báo Cáo Thu Nhập & Lịch Sử Cho Thuê
        </h2>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Tổng Thu Nhập</h6>
                            <h2 class="mb-0">@(ViewBag.Income ?? "0 VNĐ")</h2>
                            <small class="opacity-75">Đã hoàn thành</small>
                        </div>
                        <i class="fas fa-dollar-sign fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Tổng Booking</h6>
                            <h2 class="mb-0">@(ViewBag.TotalBookings ?? 0)</h2>
                            <small class="opacity-75">Lượt thuê</small>
                        </div>
                        <i class="fas fa-shopping-cart fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1 opacity-75">Đang Cho Thuê</h6>
                            <h2 class="mb-0">@(ViewBag.TotalRented ?? 0)</h2>
                            <small class="opacity-75">Máy đang thuê</small>
                        </div>
                        <i class="fas fa-laptop fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Ticket Kỹ Thuật</h6>
                            <h2 class="mb-0">@Model.Count()</h2>
                            <small>Phiếu sửa chữa</small>
                        </div>
                        <i class="fas fa-wrench fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" id="reportTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rented-tab" data-bs-toggle="tab" data-bs-target="#rented" type="button">
                <i class="fas fa-laptop me-1"></i>Đang Cho Thuê
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                <i class="fas fa-check-circle me-1"></i>Đã Hoàn Thành
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#tickets" type="button">
                <i class="fas fa-tools me-1"></i>Phiếu Kỹ Thuật
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="reportTabContent">
        <!-- Tab: Đang cho thuê -->
        <div class="tab-pane fade show active" id="rented" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-primary">Laptop Đang Được Khách Thuê</h5>
                </div>
                <div class="card-body p-0">
                    @if (rentedBookings != null && rentedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center">Mã Booking</th>
                                        <th>Laptop</th>
                                        <th>Khách Hàng</th>
                                        <th class="text-center">Ngày Thuê</th>
                                        <th class="text-center">Ngày Trả</th>
                                        <th class="text-end">Giá Thuê</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in rentedBookings)
                                    {
                                        <tr>
                                            <td class="text-center"><span class="badge bg-primary">#@booking.Id</span></td>
                                            <td>@booking.Laptop?.Name</td>
                                            <td>@(booking.Customer?.LastName) @(booking.Customer?.FirstName)</td>
                                            <td class="text-center">@booking.StartTime.ToString("dd/MM/yyyy")</td>
                                            <td class="text-center">@booking.EndTime.ToString("dd/MM/yyyy")</td>
                                            <td class="text-end fw-bold text-success">@(booking.TotalPrice?.ToString("#,##0") ?? "0") đ</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <p class="mb-0">Không có laptop nào đang được thuê</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã hoàn thành -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-success">Lịch Sử Cho Thuê Đã Hoàn Thành</h5>
                </div>
                <div class="card-body p-0">
                    @if (completedBookings != null && completedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center">Mã Receipt</th>
                                        <th>Laptop</th>
                                        <th>Khách Hàng</th>
                                        <th class="text-center">Ngày Thuê</th>
                                        <th class="text-center">Ngày Trả</th>
                                        <th class="text-end">Thu Nhập</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var receipt in completedBookings)
                                    {
                                        <tr>
                                            <td class="text-center"><span class="badge bg-success">#@receipt.Id</span></td>
                                            <td>@receipt.Booking?.Laptop?.Name</td>
                                            <td>@(receipt.Booking?.Customer?.LastName) @(receipt.Booking?.Customer?.FirstName)</td>
                                            <td class="text-center">@receipt.StartTime.ToString("dd/MM/yyyy")</td>
                                            <td class="text-center">@receipt.EndTime.ToString("dd/MM/yyyy")</td>
                                            <td class="text-end fw-bold text-success">@receipt.TotalPrice.ToString("#,##0") đ</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-history fa-3x mb-3 d-block"></i>
                            <p class="mb-0">Chưa có đơn thuê nào hoàn thành</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Phiếu kỹ thuật -->
        <div class="tab-pane fade" id="tickets" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-warning">Phiếu Kỹ Thuật</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model != null && Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center">Mã Ticket</th>
                                        <th class="text-center">Ngày Tạo</th>
                                        <th>Laptop</th>
                                        <th>Mô Tả</th>
                                        <th class="text-center">Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ticket in Model)
                                    {
                                        <tr>
                                            <td class="text-center"><span class="badge bg-primary">#@ticket.Id</span></td>
                                            <td class="text-center">@ticket.CreatedDate?.ToString("dd/MM/yyyy")</td>
                                            <td>@ticket.Laptop?.Name</td>
                                            <td>@ticket.Description</td>
                                            <td class="text-center">
                                                <span class="badge @GetStatusBadgeClass(ticket.Status?.StatusName)">
                                                    @TranslateStatus(ticket.Status?.StatusName)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <p class="mb-0">Chưa có phiếu kỹ thuật nào</p>
                            <small>Các phiếu báo lỗi máy sẽ hiển thị tại đây</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
