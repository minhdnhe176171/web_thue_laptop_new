@using web_chothue_laptop.Models
@{
    ViewData["Title"] = "Thanh Toán Online";
    var booking = ViewBag.Booking as Booking;
    var qrCodeUrl = ViewBag.QrCodeUrl as string;
    var qrCodeBase64 = ViewBag.QrCodeBase64 as string;
    
    // Kiểm tra nếu đã thanh toán thành công (StatusId = 12)
    bool isPaid = booking != null && booking.StatusId == 12;
}

<div class="container py-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-3">
        <a asp-controller="Booking" asp-action="MyBookings" class="text-decoration-none text-primary">
            ← Quay lại theo dõi đơn thuê
        </a>
    </div>

    @if (booking == null)
    {
        <!-- Form nhập mã đơn hàng -->
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-primary text-white text-center py-4">
                        <h3 class="mb-0">
                            <i class="bi bi-qr-code-scan"></i> Thanh Toán Online
                        </h3>
                    </div>
                    <div class="card-body p-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Vui lòng nhập mã đơn hàng của bạn để thanh toán online bằng QR code.
                        </div>

                        <form asp-action="OnlinePaymentPost" method="post">
                            @Html.AntiForgeryToken()
                            
                            <div asp-validation-summary="All" class="text-danger mb-3"></div>

                            <div class="mb-3">
                                <label for="bookingId" class="form-label">
                                    <strong>Mã Đơn Hàng</strong>
                                </label>
                                <input type="number" class="form-control form-control-lg" id="bookingId" name="bookingId" 
                                       placeholder="Nhập mã đơn hàng" required autofocus />
                                <small class="text-muted">Mã đơn hàng là số ID của đơn thuê của bạn</small>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-search"></i> Tìm Kiếm Đơn Hàng
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Hiển thị thông tin đơn hàng và QR code -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-success text-white text-center py-4">
                        <h3 class="mb-0">
                            <i class="bi bi-qr-code"></i> Thanh Toán Online
                        </h3>
                    </div>
                    <div class="card-body p-4">
                        <!-- Thông tin đơn hàng -->
                        <div class="mb-4">
                            <h5 class="text-muted mb-3">
                                <i class="bi bi-receipt"></i> Thông Tin Đơn Hàng
                            </h5>
                            <div class="bg-light p-3 rounded">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <strong>Mã Đơn Hàng:</strong>
                                        <p class="mb-0">#@booking.Id</p>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>Laptop:</strong>
                                        <p class="mb-0">@booking.Laptop?.Name</p>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>Hãng:</strong>
                                        <p class="mb-0">@booking.Laptop?.Brand?.BrandName</p>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>Thời gian thuê:</strong>
                                        <p class="mb-0">
                                            @booking.StartTime.ToString("dd/MM/yyyy") - @booking.EndTime.ToString("dd/MM/yyyy")
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Số tiền cần thanh toán -->
                        <div class="mb-4">
                            <h5 class="text-muted mb-3">
                                <i class="bi bi-cash-stack"></i> Số Tiền Cần Thanh Toán
                            </h5>
                            <div class="bg-light p-3 rounded">
                                <h2 class="text-success fw-bold mb-0 text-center">
                                    @if (booking.TotalPrice.HasValue)
                                    {
                                        @booking.TotalPrice.Value.ToString("N0") <span class="fs-5">VNĐ</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Chưa có thông tin</span>
                                    }
                                </h2>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Kiểm tra nếu đã thanh toán thành công (StatusId = 12) -->
                        @if (isPaid)
                        {
                            <div class="alert alert-success text-center mb-4" role="alert">
                                <h4 class="alert-heading">
                                    <i class="bi bi-check-circle-fill"></i> Đã Thanh Toán Thành Công!
                                </h4>
                                <p class="mb-0">
                                    Bạn đã thanh toán thành công cho đơn hàng #@booking.Id. Vui lòng đến gặp Staff để nhận máy.
                                </p>
                            </div>
                        }
                        else
                        {
                            <!-- QR Code VietQR MBBank -->
                            var accountName = ViewBag.AccountName as string ?? "Ha Hoang Hiep";
                            var accountNumber = ViewBag.AccountNumber as string ?? "0862735289";
                            var bankName = ViewBag.BankName as string ?? "MBBank";
                            var phoneNumber = ViewBag.PhoneNumber as string ?? "0862735289";
                            
                            @if (!string.IsNullOrEmpty(qrCodeUrl))
                            {
                                <div class="mb-4">
                                    <h5 class="text-muted mb-3">
                                        <i class="bi bi-qr-code"></i> Quét Mã QR Để Chuyển Khoản
                                    </h5>
                                    <div class="alert alert-info mb-3">
                                        <p class="mb-2">
                                            <strong>Vui lòng quét mã QR bên dưới bằng ứng dụng ngân hàng của bạn để chuyển khoản vào tài khoản MBBank.</strong>
                                        </p>
                                        <p class="mb-0 small">
                                            <i class="bi bi-info-circle"></i> Sau khi chuyển khoản thành công, hệ thống sẽ tự động cập nhật trạng thái đơn hàng.
                                        </p>
                                    </div>

                                    <!-- Thông tin tài khoản nhận tiền -->
                                    <div class="alert alert-success mb-3">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-bank"></i> Thông Tin Tài Khoản Nhận Tiền
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p class="mb-1 small">
                                                    <strong>Ngân hàng:</strong> @bankName
                                                </p>
                                                <p class="mb-1 small">
                                                    <strong>Số tài khoản:</strong> <span class="badge bg-primary">@accountNumber</span>
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="mb-1 small">
                                                    <strong>Chủ tài khoản:</strong> @accountName
                                                </p>
                                                <p class="mb-0 small">
                                                    <strong>Số điện thoại:</strong> @phoneNumber
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <div class="bg-white p-4 rounded shadow-sm d-inline-block">
                                            <img src="@qrCodeUrl" alt="QR Code Chuyển Khoản MBBank" class="img-fluid" style="max-width: 400px; min-width: 300px;" id="qrCodeImage" />
                                        </div>
                                        <p class="text-muted small mt-2">
                                            <i class="bi bi-camera"></i> Quét mã QR bằng ứng dụng ngân hàng để chuyển khoản
                                        </p>
                                    </div>
                                    
                                </div>

                                <hr class="my-4">
                            }

                            <!-- Nút thanh toán PayOS -->
                            <div class="mb-4">
                                <h5 class="text-muted mb-3">
                                    <i class="bi bi-credit-card"></i> Thanh Toán Qua PayOS
                                </h5>
                                <div class="alert alert-info mb-3">
                                    <p class="mb-2">
                                        <strong>Thanh toán nhanh chóng và an toàn qua PayOS.</strong>
                                    </p>
                                    <p class="mb-0 small">
                                        <i class="bi bi-info-circle"></i> Hỗ trợ thanh toán qua thẻ ATM, thẻ tín dụng, ví điện tử và nhiều phương thức khác.
                                    </p>
                                </div>
                                
                                <div class="text-center">
                                    <a asp-controller="Booking" asp-action="PayWithPayOS" asp-route-bookingId="@booking.Id" 
                                       class="btn btn-success btn-lg px-5 py-3">
                                        <i class="bi bi-wallet2"></i> Thanh Toán PayOS
                                    </a>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Nút thanh toán VNPay -->
                            <div class="mb-4">
                                <h5 class="text-muted mb-3">
                                    <i class="bi bi-credit-card"></i> Thanh Toán Qua VNPay
                                </h5>
                                <div class="alert alert-info mb-3">
                                    <p class="mb-2">
                                        <strong>Thanh toán nhanh chóng và an toàn qua VNPay.</strong>
                                    </p>
                                    <p class="mb-0 small">
                                        <i class="bi bi-info-circle"></i> Hỗ trợ thanh toán qua thẻ ATM, thẻ tín dụng, ví điện tử và nhiều phương thức khác.
                                    </p>
                                </div>
                                
                                <div class="text-center">
                                    <a asp-controller="Booking" asp-action="PayWithVNPay" asp-route-bookingId="@booking.Id" 
                                       class="btn btn-primary btn-lg px-5 py-3">
                                        <i class="bi bi-wallet2"></i> Thanh Toán VNPay
                                    </a>
                                </div>
                            </div>

                            <hr class="my-4">
                        }

                        <!-- Thông báo trạng thái (chỉ hiện khi chưa thanh toán) -->
                        @if (!isPaid)
                        {
                            <div id="paymentStatusAlert" class="alert alert-warning" role="alert" style="display: none;">
                                <i class="bi bi-hourglass-split"></i> <span id="statusMessage">Đang chờ thanh toán...</span>
                            </div>

                            <!-- Nút kiểm tra trạng thái -->
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-primary btn-lg" id="checkStatusBtn" onclick="checkPaymentStatus(@booking.Id)">
                                    <i class="bi bi-arrow-clockwise"></i> Kiểm Tra Trạng Thái
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
<script>
    let checkInterval;

    function checkPaymentStatus(bookingId) {
        const statusAlert = document.getElementById('paymentStatusAlert');
        const statusMessage = document.getElementById('statusMessage');
        const checkBtn = document.getElementById('checkStatusBtn');

        fetch(`/Booking/CheckPaymentStatus/${bookingId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'rented') {
                        statusAlert.className = 'alert alert-success';
                        statusMessage.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                        statusAlert.style.display = 'block';
                        checkBtn.style.display = 'none';
                        
                        setTimeout(() => {
                            window.location.href = '/Booking/MyBookings';
                        }, 3000);
                    } else if (data.status === 'paid') {
                        // Đã thanh toán thành công (StatusId = 12 - Banked)
                        // Reload trang để hiển thị thông báo "Đã thanh toán thành công" từ server
                        window.location.reload();
                    } else {
                        statusAlert.className = 'alert alert-warning';
                        statusMessage.innerHTML = '<i class="bi bi-hourglass-split"></i> ' + data.message;
                        statusAlert.style.display = 'block';
                    }
                } else {
                    statusAlert.className = 'alert alert-danger';
                    statusMessage.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + data.message;
                    statusAlert.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusAlert.className = 'alert alert-danger';
                statusMessage.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Có lỗi xảy ra khi kiểm tra trạng thái.';
                statusAlert.style.display = 'block';
            });
    }

    // Tự động kiểm tra trạng thái mỗi 3 giây nếu đang ở trang này và đã có booking (chưa thanh toán)
    @if (booking != null && !isPaid)
    {
        <text>
        // Tự động kiểm tra trạng thái mỗi 3 giây nếu đang ở trang này và đã có booking
        // Để phát hiện khi thanh toán thành công
        checkInterval = setInterval(() => {
            checkPaymentStatus(@booking.Id);
        }, 3000);
        </text>
    }

    // Dừng interval khi rời trang
    window.addEventListener('beforeunload', () => {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
    });
</script>

<style>
    .card {
        border-radius: 12px;
    }

    .card-header {
        border-radius: 12px 12px 0 0 !important;
    }

    .bg-light {
        background-color: #f8f9fa !important;
    }
</style>

