@using web_chothue_laptop.Helpers
@using web_chothue_laptop.Models
@{
    ViewData["Title"] = "Theo Dõi Đơn Thuê";
    var pendingBookings = ViewBag.PendingBookings as List<Booking> ?? new List<Booking>();
    var approvedBookings = ViewBag.ApprovedBookings as List<Booking> ?? new List<Booking>();
    var rentedBookings = ViewBag.RentedBookings as List<Booking> ?? new List<Booking>();
    var completedBookings = ViewBag.CompletedBookings as List<Booking> ?? new List<Booking>();
    var cancelledBookings = ViewBag.CancelledBookings as List<Booking> ?? new List<Booking>();
}

<div class="container py-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-3">
        <a asp-controller="Home" asp-action="Index" class="text-decoration-none text-primary">
            ← Quay lại trang chủ
        </a>
    </div>

    <h2 class="mb-4">Theo Dõi Đơn Thuê</h2>

    <!-- Thông báo đơn được duyệt -->
    @if (approvedBookings.Any())
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-check-circle"></i> Thông Báo Quan Trọng
            </h5>
            <p class="mb-2">
                <strong>Bạn có @approvedBookings.Count đơn hàng đã được duyệt!</strong>
            </p>
            <p class="mb-2">
                Vui lòng vào phần <strong>"Đã Duyệt"</strong> để xử lý thanh toán, hoặc 
                <a href="#approved" class="alert-link fw-bold" onclick="document.getElementById('approved-tab').click();">
                    bấm vào đây để đến trang thanh toán
                </a>.
            </p>
            <hr>
            <p class="mb-0 small">
                <i class="bi bi-info-circle"></i> Sau khi thanh toán, đơn hàng sẽ chuyển sang trạng thái "Đang Thuê".
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="bookingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                Chờ Duyệt 
                @if (pendingBookings.Any())
                {
                    <span class="badge bg-warning text-dark ms-2">@pendingBookings.Count</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                Đã Duyệt
                @if (approvedBookings.Any())
                {
                    <span class="badge bg-success ms-2">@approvedBookings.Count</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rented-tab" data-bs-toggle="tab" data-bs-target="#rented" type="button" role="tab">
                Đang Thuê
                @if (rentedBookings.Any())
                {
                    <span class="badge bg-info ms-2">@rentedBookings.Count</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">
                Đã Hoàn Thành
                @if (completedBookings.Any())
                {
                    <span class="badge bg-secondary ms-2">@completedBookings.Count</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                Đã Bị Hủy
                @if (cancelledBookings.Any())
                {
                    <span class="badge bg-danger ms-2">@cancelledBookings.Count</span>
                }
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="bookingTabsContent">
        <!-- Tab: Chờ Duyệt -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (pendingBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in pendingBookings)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    var statusVi = StatusHelper.GetVietnameseStatus(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClass(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đang chờ duyệt.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã Duyệt -->
        <div class="tab-pane fade" id="approved" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (approvedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in approvedBookings)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    var statusVi = StatusHelper.GetVietnameseStatus(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClass(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <a asp-controller="Booking" asp-action="Payment" asp-route-id="@booking.Id" class="btn btn-sm btn-success">
                                                    <i class="bi bi-credit-card"></i> Thanh Toán
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đã được duyệt.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đang Thuê -->
        <div class="tab-pane fade" id="rented" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (rentedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in rentedBookings)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                                <a href="@Url.Action("Details", "Laptop", new { id = booking.LaptopId })" class="small text-primary">
                                                    Xem chi tiết
                                                </a>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                                @if (booking.EndTime >= DateTime.Today && booking.StartTime <= DateTime.Now)
                                                {
                                                    <div class="small text-success mt-1">
                                                        <i class="bi bi-check-circle"></i> Đang trong thời gian thuê
                                                    </div>
                                                }
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    var statusVi = StatusHelper.GetVietnameseStatus(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClass(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <a asp-controller="Ticket" asp-action="Create" asp-route-id="@booking.LaptopId" asp-route-bookingId="@booking.Id" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-exclamation-triangle"></i> Báo Lỗi
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đang thuê.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã Hoàn Thành -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (completedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in completedBookings)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    var statusVi = StatusHelper.GetVietnameseStatus(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClass(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đã hoàn thành.</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã Bị Hủy -->
        <div class="tab-pane fade" id="cancelled" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (cancelledBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in cancelledBookings)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    var statusVi = StatusHelper.GetVietnameseStatus(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClass(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào bị hủy.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-tabs .nav-link {
        color: #495057;
        border: none;
        border-bottom: 2px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: #dee2e6;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    .card {
        border: 1px solid #dee2e6;
    }

    .table th {
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script>
        @{
            var customerId = ViewBag.CustomerId as long?;
        }
        
        @if (customerId.HasValue)
        {
            <text>
            const bookingConnection = new signalR.HubConnectionBuilder()
                .withUrl("/bookinghub")
                .build();

            const customerId = @customerId.Value;

            bookingConnection.start().then(function () {
                console.log("Booking Hub Connected");
                bookingConnection.invoke("JoinCustomerGroup", customerId).then(function () {
                    console.log("Joined customer booking group:", customerId);
                }).catch(function (err) {
                    console.error("Error joining customer booking group:", err.toString());
                });
            }).catch(function (err) {
                console.error("Booking Hub connection error:", err.toString());
            });

            // Lắng nghe khi booking status được cập nhật
            bookingConnection.on("BookingStatusUpdated", function (data) {
                console.log("Booking status updated:", data);
                
                if (data.bookingId && data.newStatusId) {
                    // Hiển thị thông báo
                    if (data.newStatusId === 2) {
                        // Đã duyệt
                        showNotification("Đơn hàng #" + data.bookingId + " đã được duyệt! Vui lòng vào phần 'Đã Duyệt' để xử lý thanh toán.", "success");
                        // Reload trang sau 2 giây để cập nhật danh sách
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else if (data.newStatusId === 10) {
                        // Đã chuyển sang Rented
                        showNotification("Đã xác nhận giao dịch thành công. Vui lòng trả máy đúng hạn. Cảm ơn quý khách!", "success");
                        // Reload trang sau 3 giây để cập nhật danh sách
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    } else if (data.newStatusId === 3) {
                        // Đã bị hủy
                        showNotification("Đơn hàng #" + data.bookingId + " đã bị hủy.", "warning");
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                }
            });

            function showNotification(message, type) {
                const alertClass = type === "success" ? "alert-success" : type === "warning" ? "alert-warning" : "alert-info";
                const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', alertHtml);
                
                // Tự động đóng sau 5 giây
                setTimeout(() => {
                    const alert = document.querySelector('.alert:last-of-type');
                    if (alert) {
                        alert.remove();
                    }
                }, 5000);
            }
            </text>
        }
    </script>
}

