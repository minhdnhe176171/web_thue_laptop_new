@using web_chothue_laptop.Helpers
@using web_chothue_laptop.Models
@{
    ViewData["Title"] = "Theo Dõi Đơn Thuê";
    var paginatedPending = ViewBag.PaginatedPending as PaginatedList<Booking>;
    var paginatedApproved = ViewBag.PaginatedApproved as PaginatedList<Booking>;
    var paginatedRented = ViewBag.PaginatedRented as PaginatedList<Booking>;
    var paginatedCompleted = ViewBag.PaginatedCompleted as PaginatedList<Booking>;
    var paginatedCancelled = ViewBag.PaginatedCancelled as PaginatedList<Booking>;
    var pageIndex = ViewBag.PageIndex as int? ?? 1;
    var tabValue = ViewBag.Tab as string ?? "all";
    var searchValue = ViewBag.Search as string ?? "";
    var statusValue = ViewBag.Status as string ?? "";
    var approvedCount = ViewBag.ApprovedCount as int? ?? 0;
    var pendingCount = ViewBag.PendingCount as int? ?? 0;
    var rentedCount = ViewBag.RentedCount as int? ?? 0;
    var completedCount = ViewBag.CompletedCount as int? ?? 0;
    var cancelledCount = ViewBag.CancelledCount as int? ?? 0;
    var paginatedBookings = ViewBag.PaginatedBookings as PaginatedList<Booking>;
    var customerId = ViewBag.CustomerId as long?;
}

<div class="container py-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-3">
        <a asp-controller="Home" asp-action="Index" class="text-decoration-none text-primary">
            ← Quay lại trang chủ
        </a>
    </div>

    <h2 class="mb-4">Theo Dõi Đơn Thuê</h2>

    <!-- Form tìm kiếm và filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="@Url.Action("MyBookings", "Booking")" class="row g-3">
                <input type="hidden" name="tab" value="@tabValue" />
                <div class="col-md-6">
                    <label for="search" class="form-label">Tìm kiếm</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="@searchValue" placeholder="Mã đơn, tên laptop, hãng...">
                </div>
                <div class="col-md-4">
                    <label for="status" class="form-label">Trạng thái</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Tất cả trạng thái</option>
                        @{
                            var status1Selected = statusValue == "1";
                            var status2Selected = statusValue == "2";
                            var status10Selected = statusValue == "10";
                            var status8Selected = statusValue == "8";
                            var status3Selected = statusValue == "3";
                        }
                        <option value="1" selected="@(status1Selected ? "selected" : null)">Chờ Duyệt</option>
                        <option value="2" selected="@(status2Selected ? "selected" : null)">Đã Duyệt</option>
                        <option value="10" selected="@(status10Selected ? "selected" : null)">Đang Thuê</option>
                        <option value="8" selected="@(status8Selected ? "selected" : null)">Đã Hoàn Thành</option>
                        <option value="3" selected="@(status3Selected ? "selected" : null)">Đã Bị Hủy</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Tìm kiếm
                    </button>
                </div>
                @if (!string.IsNullOrWhiteSpace(searchValue) || !string.IsNullOrWhiteSpace(statusValue))
                {
                    <div class="col-12">
                        <a href="@Url.Action("MyBookings", "Booking")" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x-circle"></i> Xóa bộ lọc
                        </a>
                    </div>
                }
            </form>
        </div>
    </div>

    <!-- Thông báo đơn được duyệt -->
    @if (approvedCount > 0)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-check-circle"></i> Thông Báo Quan Trọng
            </h5>
            <p class="mb-2">
                <strong>Bạn có @approvedCount đơn hàng đã được duyệt!</strong>
            </p>
            <p class="mb-2">
                Vui lòng vào phần <strong>"Đã Duyệt"</strong> để xử lý thanh toán, hoặc 
                <a href="#approved" class="alert-link fw-bold" onclick="document.getElementById('approved-tab').click();">
                    bấm vào đây để đến trang thanh toán
                </a>.
            </p>
            <hr>
            <p class="mb-0 small">
                <i class="bi bi-info-circle"></i> Sau khi thanh toán thành công, vui lòng đến gặp Staff để nhận máy và xác nhận đã nhận máy.
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="bookingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link @(tabValue == "all" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "all", search = searchValue, status = statusValue, page = 1 })">
                Tất Cả
                @if (paginatedBookings != null && paginatedBookings.Any())
                {
                    <span class="badge bg-primary ms-2">@paginatedBookings.Count</span>
                }
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(tabValue == "pending" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "pending", search = searchValue, status = statusValue, page = 1 })">
                Chờ Duyệt 
                @if (pendingCount > 0)
                {
                    <span class="badge bg-warning text-dark ms-2">@pendingCount</span>
                }
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(tabValue == "approved" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "approved", search = searchValue, status = statusValue, page = 1 })">
                Đã Duyệt
                @if (approvedCount > 0)
                {
                    <span class="badge bg-success ms-2">@approvedCount</span>
                }
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(tabValue == "rented" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "rented", search = searchValue, status = statusValue, page = 1 })">
                Đang Thuê
                @if (rentedCount > 0)
                {
                    <span class="badge bg-info ms-2">@rentedCount</span>
                }
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(tabValue == "completed" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "completed", search = searchValue, status = statusValue, page = 1 })">
                Đã Hoàn Thành
                @if (completedCount > 0)
                {
                    <span class="badge bg-secondary ms-2">@completedCount</span>
                }
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link @(tabValue == "cancelled" ? "active" : "")" href="@Url.Action("MyBookings", new { tab = "cancelled", search = searchValue, status = statusValue, page = 1 })">
                Đã Bị Hủy
                @if (cancelledCount > 0)
                {
                    <span class="badge bg-danger ms-2">@cancelledCount</span>
                }
            </a>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="bookingTabsContent">
        <!-- Tab: Tất Cả (với filter và phân trang) -->
        <div class="tab-pane fade @(tabValue == "all" ? "show active" : "")" id="all" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @{
                        var totalPages = paginatedBookings?.TotalPages ?? 1;
                        var hasPreviousPage = paginatedBookings?.HasPreviousPage ?? false;
                        var hasNextPage = paginatedBookings?.HasNextPage ?? false;
                    }
                    @if (paginatedBookings != null && paginatedBookings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in paginatedBookings)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    // Dùng GetVietnameseStatusForHistory để hiển thị "closed" là "Đã hoàn thành" và "banked" là "Đã chuyển khoản" trong theo dõi đơn thuê
                                                    // Dùng GetStatusBadgeClassForHistory để có màu đúng cho theo dõi đơn thuê
                                                    var statusVi = StatusHelper.GetVietnameseStatusForHistory(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClassForHistory(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (booking.StatusId == 2)
                                                {
                                                    <a asp-controller="Booking" asp-action="Payment" asp-route-id="@booking.Id" class="btn btn-sm btn-success">
                                                        <i class="bi bi-credit-card"></i> Thanh Toán
                                                    </a>
                                                }
                                                else if (booking.StatusId == 10)
                                                {
                                                    <a href="@Url.Action("Details", "Laptop", new { id = booking.LaptopId })" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-eye"></i> Xem Chi Tiết
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Không tìm thấy đơn thuê nào.</p>
                        </div>
                    }
                    
                    <!-- Phân trang - Luôn hiển thị -->
                    @if (paginatedBookings != null)
                    {
                        var displayPages = Math.Max(totalPages, 3);
                        var hasPreviousDisplay = pageIndex > 1;
                        var hasNextDisplay = pageIndex < displayPages;
                        <nav aria-label="Page navigation" class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(!hasPreviousDisplay ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex - 1, search = searchValue, status = statusValue, tab = "all" })" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                @for (int i = 1; i <= displayPages; i++)
                                {
                                    <li class="page-item @(i == pageIndex ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("MyBookings", new { page = i, search = searchValue, status = statusValue, tab = "all" })">@i</a>
                                    </li>
                                }
                                <li class="page-item @(!hasNextDisplay ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex + 1, search = searchValue, status = statusValue, tab = "all" })" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Chờ Duyệt -->
        <div class="tab-pane fade @(tabValue == "pending" ? "show active" : "")" id="pending" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (paginatedPending != null && paginatedPending.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in paginatedPending)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    // Dùng GetVietnameseStatusForHistory để hiển thị "closed" là "Đã hoàn thành" và "banked" là "Đã chuyển khoản" trong theo dõi đơn thuê
                                                    // Dùng GetStatusBadgeClassForHistory để có màu đúng cho theo dõi đơn thuê
                                                    var statusVi = StatusHelper.GetVietnameseStatusForHistory(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClassForHistory(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đang chờ duyệt.</p>
                        </div>
                    }
                    
                    <!-- Phân trang - Luôn hiển thị -->
                    @if (paginatedPending != null)
                    {
                        var displayPagesPending = Math.Max(paginatedPending.TotalPages, 3);
                        var hasPreviousPending = pageIndex > 1;
                        var hasNextPending = pageIndex < displayPagesPending;
                        <nav aria-label="Page navigation" class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(!hasPreviousPending ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex - 1, search = searchValue, tab = "pending" })" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                @for (int i = 1; i <= displayPagesPending; i++)
                                {
                                    <li class="page-item @(i == pageIndex ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("MyBookings", new { page = i, search = searchValue, tab = "pending" })">@i</a>
                                    </li>
                                }
                                <li class="page-item @(!hasNextPending ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex + 1, search = searchValue, tab = "pending" })" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã Duyệt -->
        <div class="tab-pane fade @(tabValue == "approved" ? "show active" : "")" id="approved" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (paginatedApproved != null && paginatedApproved.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in paginatedApproved)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    // Dùng GetVietnameseStatusForHistory để hiển thị "closed" là "Đã hoàn thành" và "banked" là "Đã chuyển khoản" trong theo dõi đơn thuê
                                                    // Dùng GetStatusBadgeClassForHistory để có màu đúng cho theo dõi đơn thuê
                                                    var statusVi = StatusHelper.GetVietnameseStatusForHistory(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClassForHistory(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @{
                                                    var now = DateTime.Now;
                                                    var isTimeValid = booking.StartTime <= now && booking.EndTime >= now;
                                                }
                                                @if (string.IsNullOrEmpty(booking.IdNoUrl) || string.IsNullOrEmpty(booking.StudentUrl))
                                                {
                                                    <a asp-controller="Booking" asp-action="UploadDocuments" asp-route-id="@booking.Id" class="btn btn-sm btn-warning">
                                                        <i class="bi bi-cloud-upload"></i> Upload Tài Liệu
                                                    </a>
                                                }
                                                else if (!isTimeValid)
                                                {
                                                    if (booking.EndTime < now)
                                                    {
                                                        <span class="badge bg-danger">Đã hết hạn</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-info">Chưa đến hạn</span>
                                                    }
                                                }
                                                else
                                                {
                                                    <a asp-controller="Booking" asp-action="Payment" asp-route-id="@booking.Id" class="btn btn-sm btn-success">
                                                        <i class="bi bi-credit-card"></i> Thanh Toán
                                                    </a>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đã được duyệt.</p>
                        </div>
                    }
                    
                    <!-- Phân trang - Luôn hiển thị -->
                    @if (paginatedApproved != null)
                    {
                        var displayPagesApproved = Math.Max(paginatedApproved.TotalPages, 3);
                        var hasPreviousApproved = pageIndex > 1;
                        var hasNextApproved = pageIndex < displayPagesApproved;
                        <nav aria-label="Page navigation" class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(!hasPreviousApproved ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex - 1, search = searchValue, tab = "approved" })" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                @for (int i = 1; i <= displayPagesApproved; i++)
                                {
                                    <li class="page-item @(i == pageIndex ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("MyBookings", new { page = i, search = searchValue, tab = "approved" })">@i</a>
                                    </li>
                                }
                                <li class="page-item @(!hasNextApproved ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex + 1, search = searchValue, tab = "approved" })" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đang Thuê -->
        <div class="tab-pane fade @(tabValue == "rented" ? "show active" : "")" id="rented" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (paginatedRented != null && paginatedRented.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in paginatedRented)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                                <a href="@Url.Action("Details", "Laptop", new { id = booking.LaptopId })" class="small text-primary">
                                                    Xem chi tiết
                                                </a>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                                @if (booking.EndTime >= DateTime.Today && booking.StartTime <= DateTime.Now)
                                                {
                                                    <div class="small text-success mt-1">
                                                        <i class="bi bi-check-circle"></i> Đang trong thời gian thuê
                                                    </div>
                                                }
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    // Dùng GetVietnameseStatusForHistory để hiển thị "closed" là "Đã hoàn thành" và "banked" là "Đã chuyển khoản" trong theo dõi đơn thuê
                                                    // Dùng GetStatusBadgeClassForHistory để có màu đúng cho theo dõi đơn thuê
                                                    var statusVi = StatusHelper.GetVietnameseStatusForHistory(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClassForHistory(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <a asp-controller="Ticket" asp-action="Create" asp-route-id="@booking.LaptopId" asp-route-bookingId="@booking.Id" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-exclamation-triangle"></i> Báo Lỗi
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đang thuê.</p>
                        </div>
                    }
                    
                    <!-- Phân trang - Luôn hiển thị -->
                    @if (paginatedRented != null)
                    {
                        var displayPagesRented = Math.Max(paginatedRented.TotalPages, 3);
                        var hasPreviousRented = pageIndex > 1;
                        var hasNextRented = pageIndex < displayPagesRented;
                        <nav aria-label="Page navigation" class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(!hasPreviousRented ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex - 1, search = searchValue, tab = "rented" })" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                @for (int i = 1; i <= displayPagesRented; i++)
                                {
                                    <li class="page-item @(i == pageIndex ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("MyBookings", new { page = i, search = searchValue, tab = "rented" })">@i</a>
                                    </li>
                                }
                                <li class="page-item @(!hasNextRented ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex + 1, search = searchValue, tab = "rented" })" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã Hoàn Thành -->
        <div class="tab-pane fade @(tabValue == "completed" ? "show active" : "")" id="completed" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (paginatedCompleted != null && paginatedCompleted.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in paginatedCompleted)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    // Dùng GetVietnameseStatusForHistory để hiển thị "closed" là "Đã hoàn thành" và "banked" là "Đã chuyển khoản" trong theo dõi đơn thuê
                                                    // Dùng GetStatusBadgeClassForHistory để có màu đúng cho theo dõi đơn thuê
                                                    var statusVi = StatusHelper.GetVietnameseStatusForHistory(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClassForHistory(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào đã hoàn thành.</p>
                        </div>
                    }
                    
                    <!-- Phân trang - Luôn hiển thị -->
                    @if (paginatedCompleted != null)
                    {
                        var displayPagesCompleted = Math.Max(paginatedCompleted.TotalPages, 3);
                        var hasPreviousCompleted = pageIndex > 1;
                        var hasNextCompleted = pageIndex < displayPagesCompleted;
                        <nav aria-label="Page navigation" class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(!hasPreviousCompleted ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex - 1, search = searchValue, tab = "completed" })" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                @for (int i = 1; i <= displayPagesCompleted; i++)
                                {
                                    <li class="page-item @(i == pageIndex ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("MyBookings", new { page = i, search = searchValue, tab = "completed" })">@i</a>
                                    </li>
                                }
                                <li class="page-item @(!hasNextCompleted ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex + 1, search = searchValue, tab = "completed" })" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>

        <!-- Tab: Đã Bị Hủy -->
        <div class="tab-pane fade @(tabValue == "cancelled" ? "show active" : "")" id="cancelled" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    @if (paginatedCancelled != null && paginatedCancelled.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Mã Đơn</th>
                                        <th>Laptop</th>
                                        <th>Thời Gian Thuê</th>
                                        <th>Tổng Tiền</th>
                                        <th>Ngày Tạo</th>
                                        <th>Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in paginatedCancelled)
                                    {
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-secondary rounded-pill">#@booking.Id</span>
                                            </td>
                                            <td>
                                                <strong>@booking.Laptop?.Name</strong>
                                                <div class="small text-muted">@booking.Laptop?.Brand?.BrandName</div>
                                            </td>
                                            <td>
                                                <div>Từ: <strong>@booking.StartTime.ToString("dd/MM/yyyy")</strong></div>
                                                <div>Đến: <strong>@booking.EndTime.ToString("dd/MM/yyyy")</strong></div>
                                            </td>
                                            <td>
                                                @if (booking.TotalPrice.HasValue)
                                                {
                                                    <span class="text-primary fw-bold">@booking.TotalPrice.Value.ToString("N0") VNĐ</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có</span>
                                                }
                                            </td>
                                            <td>@(booking.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                            <td>
                                                @if (booking.Status != null)
                                                {
                                                    // Dùng GetVietnameseStatusForHistory để hiển thị "closed" là "Đã hoàn thành" và "banked" là "Đã chuyển khoản" trong theo dõi đơn thuê
                                                    // Dùng GetStatusBadgeClassForHistory để có màu đúng cho theo dõi đơn thuê
                                                    var statusVi = StatusHelper.GetVietnameseStatusForHistory(booking.Status.StatusName);
                                                    var badgeClass = StatusHelper.GetStatusBadgeClassForHistory(booking.Status.StatusName);
                                                    <span class="badge @badgeClass">@statusVi</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-0">Bạn chưa có đơn nào bị hủy.</p>
                        </div>
                    }
                    
                    <!-- Phân trang - Luôn hiển thị -->
                    @if (paginatedCancelled != null)
                    {
                        var displayPagesCancelled = Math.Max(paginatedCancelled.TotalPages, 3);
                        var hasPreviousCancelled = pageIndex > 1;
                        var hasNextCancelled = pageIndex < displayPagesCancelled;
                        <nav aria-label="Page navigation" class="p-3">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item @(!hasPreviousCancelled ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex - 1, search = searchValue, tab = "cancelled" })" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                @for (int i = 1; i <= displayPagesCancelled; i++)
                                {
                                    <li class="page-item @(i == pageIndex ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("MyBookings", new { page = i, search = searchValue, tab = "cancelled" })">@i</a>
                                    </li>
                                }
                                <li class="page-item @(!hasNextCancelled ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("MyBookings", new { page = pageIndex + 1, search = searchValue, tab = "cancelled" })" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-tabs .nav-link {
        color: #495057;
        border: none;
        border-bottom: 2px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: #dee2e6;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    .card {
        border: 1px solid #dee2e6;
    }

    .table th {
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script>
        @if (customerId.HasValue)
        {
            <text>
            const bookingConnection = new signalR.HubConnectionBuilder()
                .withUrl("/bookinghub")
                .build();

            const customerId = @(customerId.Value.ToString());

            bookingConnection.start().then(function () {
                console.log("Booking Hub Connected");
                bookingConnection.invoke("JoinCustomerGroup", customerId).then(function () {
                    console.log("Joined customer booking group:", customerId);
                }).catch(function (err) {
                    console.error("Error joining customer booking group:", err.toString());
                });
            }).catch(function (err) {
                console.error("Booking Hub connection error:", err.toString());
            });

            // Lắng nghe khi booking status được cập nhật
            bookingConnection.on("BookingStatusUpdated", function (data) {
                console.log("Booking status updated:", data);
                
                if (data.bookingId && data.newStatusId) {
                    // Hiển thị thông báo
                    if (data.newStatusId === 2) {
                        // Đã duyệt
                        showNotification("Đơn hàng #" + data.bookingId + " đã được duyệt! Vui lòng vào phần 'Đã Duyệt' để xử lý thanh toán.", "success");
                        // Reload trang sau 2 giây để cập nhật danh sách
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else if (data.newStatusId === 10) {
                        // Đã chuyển sang Rented
                        showNotification("Đã xác nhận giao dịch thành công. Vui lòng trả máy đúng hạn. Cảm ơn quý khách!", "success");
                        // Reload trang sau 3 giây để cập nhật danh sách
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    } else if (data.newStatusId === 3) {
                        // Đã bị hủy
                        showNotification("Đơn hàng #" + data.bookingId + " đã bị hủy.", "warning");
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                }
            });

            function showNotification(message, type) {
                const alertClass = type === "success" ? "alert-success" : type === "warning" ? "alert-warning" : "alert-info";
                const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', alertHtml);
                
                // Tự động đóng sau 5 giây
                setTimeout(() => {
                    const alert = document.querySelector('.alert:last-of-type');
                    if (alert) {
                        alert.remove();
                    }
                }, 5000);
            }
            </text>
        }
    </script>
}

